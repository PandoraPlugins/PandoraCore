package dev.minecraftplugin.pandoracore.patch.patches.exploit;

import com.azortis.azortislib.configuration.Config;
import com.azortis.azortislib.utils.FormatUtil;
import dev.minecraftplugin.pandoracore.PandoraCore;
import dev.minecraftplugin.pandoracore.patch.Patch;
import net.minecraft.server.v1_8_R3.Packet;
import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.player.PlayerLoginEvent;

import java.io.Serializable;
import java.util.ArrayList;
import java.util.List;

public class NullAddressPatch extends Patch<Packet<?>> {
    private Config<NullAddressPatchData> config;

    public NullAddressPatch() {
        super("NullAddressPatch", "Prevents players from sending null adresses to bypass ipwhitelist",
                false, false, null, true);
    }

    @Override
    public void enable(PandoraCore core) {
        config = core.getConfigManager().loadConfig("/patches/exploits/nullpatch.json", new NullAddressPatchData());
    }

    @EventHandler
    public void onPlayerLogin(PlayerLoginEvent event) {
        if (event.getAddress() == null) {
            config.getConfiguration().commands.forEach(s -> Bukkit.dispatchCommand(Bukkit.getConsoleSender(),
                    s.replace("%player%", event.getPlayer().getName())));
            if (config.getConfiguration().cancel) event.disallow(PlayerLoginEvent.Result.KICK_OTHER,
                    FormatUtil.color(config.getConfiguration().cancelMessage));
        }
    }

    @Override
    public void disable(PandoraCore core) {
        config.saveConfig();
    }

    private static class NullAddressPatchData implements Serializable {
        public List<String> commands;
        public boolean cancel = true;
        public String cancelMessage = "&6Your address is null!";

        public NullAddressPatchData() {
            commands = new ArrayList<>();
            commands.add("kick %player% Yoted");
        }
    }
}

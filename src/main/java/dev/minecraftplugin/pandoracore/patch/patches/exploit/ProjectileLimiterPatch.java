package dev.minecraftplugin.pandoracore.patch.patches.exploit;

import dev.minecraftplugin.pandoracore.PandoraCore;
import dev.minecraftplugin.pandoracore.patch.Patch;
import net.minecraft.server.v1_8_R3.Packet;
import org.bukkit.Bukkit;
import org.bukkit.entity.Player;
import org.bukkit.event.EventHandler;
import org.bukkit.event.entity.ProjectileLaunchEvent;

import java.util.HashMap;
import java.util.Map;

// todo: wanted to use packets for this, but unfortunately couldn't find the use item packet.
public class ProjectileLimiterPatch extends Patch<Packet<?>> {
    private Map<Player, Integer> entityCount;

    public ProjectileLimiterPatch() {
        super("ProjectileLimiterPatch", "Limits number of projectiles thrown every second.", false, false,
                null, true);
    }

    @Override
    public void enable(PandoraCore core) {
        entityCount = new HashMap<>();
        Bukkit.getScheduler().scheduleSyncRepeatingTask(core, () -> {
            entityCount.clear();
        }, 20, 20);
    }

    @EventHandler
    public void onPlayerThrow(ProjectileLaunchEvent event) {
        if (event.getEntity().getShooter() instanceof Player) {
            Player p = (Player) event.getEntity().getShooter();
            if (entityCount.containsKey(p)) {
                int count = entityCount.get(p);
                if (count + 1 > 15) event.setCancelled(true);
                else entityCount.put(p, count + 1);
            } else {
                entityCount.put(p, 1);
            }
        }
    }

    @Override
    public void disable(PandoraCore core) {

    }
}
